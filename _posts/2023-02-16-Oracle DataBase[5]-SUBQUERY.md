---
layout: post
title: Oracle DataBase[5] - SUBQUERY
---

## SUBQUERY(서브쿼리)

### 서브쿼리란?
- 서브쿼리란 하나의 쿼리 문장 내에 포함된 또 하나의 쿼리 문장을 말한다.
- 이때 바깥에 있는 SQL문을 메인쿼리(Main Query)라 부른다.
- 서브쿼리를 사용할때는 반드시 괄호로 묶어주어야한다.
- 메인 쿼리가 실행되기 전 한 번만 실행된다.
- 서브쿼리와 비교할 항목은 반드시 서브쿼리의 SELECT한 항목의 개수와 자료형을 일치시켜야 한다.
---------------------------------------------------------------------

- 유형
    1. 단일행 서브쿼리
        - 서브쿼리의 조회 결과 값의 개수가 1개인 서브쿼리
    2. 다중행 서브쿼리
        - 서브쿼리의 조회 결과 값의 행이 여러 개인 서브쿼리
    3. 다중열 서브쿼리
        - 서브쿼리의 조회 결과 컬럼의 개수가 여러 개인 서브쿼리
    4. 다중행 다중열 서브쿼리
        - 서브쿼리의 조회 결과 컬럼의 개수와 행의 개수가 여러 개인 서브쿼리
    5. 상(호연)관 서브쿼리
        - 서브쿼리가 만든 결과 값을 메인 쿼리가 비교 연산할 때 메인 쿼리
        - 테이블의 값이 변경되면 서브쿼리의 결과 값도 바뀌는 서브쿼리
    6. 스칼라 서브쿼리
        - 상관쿼리이면서 결과 값이 한개인 서브쿼리

---------------------------------------------------------------------

- 위치에 따른 서브쿼리
    - SELECT 절 서브쿼리 ( 스칼라 서브쿼리 )
        - 스칼라 서브쿼리라고 불리며 SELECT 절 안에 서브쿼리가 들어있다.
        - 이 때, 서브쿼리의 결과는 반드시 단일 행이나 SUM, COUNT 등의 집계 함수를 거친 단일 값으로 리턴되어야 한다.
        - 이유는 서브쿼리를 끝마친 값하나를 메인쿼리에서 SELECT 하기 때문이다.
        
        ```sql
        -- 각사원이 속한 부서의 평균급여를 사원명, 부서코드, 직책코드, 급여와 같이 출력
        SELECT 
            EMP_NAME, DEPT_CODE, JOB_CODE, SALARY, (SELECT AVG(SALARY) FROM EMPLOYEE WHERE E.DEPT_CODE = DEPT_CODE)
        FROM EMPLOYEE E;
        ```
        
    - FROM 절 서브쿼리 ( 인라인뷰 서브쿼리 )
        - 인라인뷰(Inline Views)라고 불리며 FROM 절 안에 서브쿼리(다중행, 다중열)가 들어있다.
        - 1회용으로 SELECT문의 결과를 테이블로 사용 : SQL문이 실행될때만 일시적으로 생성이 된다는 것이다.
            - 일반적인 뷰를 정적뷰, 인라인 뷰를  동적 뷰라고도 한다.
        - 이 때, 서브쿼리의 결과는 반드시 하나의 테이블로 리턴되어야 한다.
        - 이유는 서브쿼리를 끝마친 테이블 하나를 메인쿼리의 FROM 에서 테이블로 잡기 때문.
        
        ```sql
        SELECT ROWNUM, EMP_NAME, SALARY
        FROM (SELECT * 
                FROM EMPLOYEE 
                ORDER BY SALARY DESC)
        WHERE ROWNUM <= 5;
        ```
    - WHERE 절 서브쿼리 ( 중첩 서브쿼리 )
        - 중첩 서브쿼리 ( Nested Subqueries ) 라고 불리며 WHERE 절 안에 서브쿼리가 들어있다.
        - 가장 자주 쓰이는 대중적인 서브쿼리이며 단일행과 복수행 둘 다 리턴이 가능하다.
        - 서브쿼리를 끝마친 값들을 메인쿼리의 조건절을 통해 비교등을 하기 때문.
 



